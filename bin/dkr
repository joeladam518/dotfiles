#!/usr/bin/env bash

set -Eeo pipefail

# Variables
ST_DT_DIR="${HOME}/devop-tools"
ST_DSS_DIR="${ST_DT_DIR}/docker/data-source-services"
ST_DST_DIR="${ST_DT_DIR}/docker/data-source-tools"

# Detect docker compose command
if docker compose &> /dev/null; then
    DOCKER_COMPOSE=(docker compose)
else
    DOCKER_COMPOSE=(docker-compose)
fi

# --- Helper functions ---

usage() {
    cat <<EOF

Usage: $(basename "${0}") [-h] COMMAND [options] [arguments]

dkr is a smart forwarder script that detects your project type and forwards commands
to the appropriate tool.

Modes:
  sourcetoad    Proxies to hop (${ST_DT_DIR}/bin/hop)
  laravel/sail  Proxies to ./vendor/bin/sail
  docker        Proxies to ${DOCKER_COMPOSE[*]}

Commands:
  connect       Bring the STDTK data-source-services and data-source-tools up
  disconnect    Bring the STDTK data-source-services and data-source-tools down

Options:
  -h, --help    Print this help and exit

Run 'dkr help' to see the proxied tool's help (hop/sail/docker compose).

EOF
    return 0
}

connect() {
    if ! docker info > /dev/null 2>&1; then
        cmsg -w "Docker is not running." 1>&2
        exit 1
    fi

    if [ ! -d "$ST_DSS_DIR" ]; then
        cmsg -r "data-source-services not found at ${ST_DSS_DIR}" 1>&2
        return 1
    fi

    if [ ! -d "$ST_DST_DIR" ]; then
        cmsg -r "data-source-tools not found at ${ST_DST_DIR}" 1>&2
        return 1
    fi

    local BUILD="0"
    if [ "$1" == "-b" ] || [ "$1" == "--build" ]; then
        shift 1
        BUILD="1"
    fi

    if [ "$BUILD" == "1" ]; then
        ( cd "$ST_DSS_DIR" && "${DOCKER_COMPOSE[@]}" up --build -d ) && ( cd "$ST_DST_DIR" && "${DOCKER_COMPOSE[@]}" up --build -d )
    else
        ( cd "$ST_DSS_DIR" && "${DOCKER_COMPOSE[@]}" up -d ) && ( cd "$ST_DST_DIR" && "${DOCKER_COMPOSE[@]}" up -d )
    fi
}

disconnect() {
    if ! docker info > /dev/null 2>&1; then
        cmsg -w "Docker is not running." 1>&2
        exit 1
    fi

    if [ ! -d "$ST_DSS_DIR" ]; then
        cmsg -r "data-source-services not found at ${ST_DSS_DIR}" 1>&2
        return 1
    fi

    if [ ! -d "$ST_DST_DIR" ]; then
        cmsg -r "data-source-tools not found at ${ST_DST_DIR}" 1>&2
        return 1
    fi

    ( cd "$ST_DSS_DIR" && "${DOCKER_COMPOSE[@]}" down ) && ( cd "$ST_DST_DIR" && "${DOCKER_COMPOSE[@]}" down )
}

# --- Locate docker-compose file ---

find_docker_compose_file() {
    if [ -f "./docker-compose.yml" ]; then
        echo "./docker-compose.yml"
    fi

    if [ -f "./docker/docker-compose.yml" ]; then
        echo "./docker/docker-compose.yml"
    fi
}

# --- Detect project type ---

is_sourcetoad_laravel_project() {
    local compose_file
    compose_file="$(find_docker_compose_file)"

    [ -f "./artisan" ] || return 1
    [ -n "$compose_file" ] || return 1

    # Check for st-internal network first
    if grep -q 'st-internal' "$compose_file" 2>/dev/null; then
        return 0
    fi

    # Fall back to sourcetoad_ container name prefix
    if grep -q 'sourcetoad_' "$compose_file" 2>/dev/null; then
        return 0
    fi

    return 1
}

is_laravel_sail_project() {
    if [ -f "./artisan" ] && [ -f "./vendor/bin/sail" ]; then
        return 0
    else
        return 1
    fi
}

# --- Handle dkr-specific commands first ---

if [ $# -eq 0 ]; then
    usage
    exit
fi

if [ "$1" == "-h" ] || [ "$1" == "--help" ]; then
    usage
    exit
fi

if [ "$1" == "connect" ]; then
    shift 1
    connect "$@"
    exit
fi

if [ "$1" == "disconnect" ]; then
    shift 1
    disconnect "$@"
    exit
fi

# --- Check if Docker is running ---

if ! docker info > /dev/null 2>&1; then
    cmsg -w "Docker is not running." 1>&2
    exit 1
fi

# --- Confirm docker-compose file exists ---
docker_compose_file_path="$(find_docker_compose_file)"

if [ -z "$docker_compose_file_path" ]; then
    cmsg -r "No docker-compose.yml found." 1>&2
    exit 1
fi

# --- Forward ---

if is_sourcetoad_laravel_project; then
    exec "${ST_DT_DIR}/bin/hop" "$@"
elif is_laravel_sail_project; then
    exec ./vendor/bin/sail "$@"
else
    exec "${DOCKER_COMPOSE[@]}" -f "$docker_compose_file_path" "$@"
fi
