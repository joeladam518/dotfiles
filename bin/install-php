#!/usr/bin/env python3
import argparse
import csv
import os
import platform
import subprocess
import sys
from collections import OrderedDict
from typing import Optional, Union

# Constants
SUCCESS = 0
FAILURE = 1

# Globals
__os_release_data = {}
php_extensions = {
    "desktop": (),
    "dev": ('dev', 'igbinary', 'intl', 'memcached', 'redis', 'xdebug'),
    "server": ('fpm', 'gd', 'igbinary', 'intl', 'memcached', 'redis'),
}
php_versions = {
    "install": ('7.4', '8.0', '8.1'),
    "uninstall": ('5.4', '5.5', '5.6', '7.0', '7.1', '7.2', '7.3', '7.4', '8.0', '8.1'),
}


# Functions
def confirm(question: str, tries: int = 2) -> bool:
    question = f"{question} [y/N] "
    valid = {"yes": True, "ye": True, "y": True, "no": False, "n": False}

    while tries > 0:
        choice = input(question).lower()
        if choice in valid:
            return valid[choice]
        tries = tries - 1
        if tries > 0:
            print('Error: invalid input')
            print("options: yes | y | no | n")

    return False


def exclude(items: Union[list, tuple], exclude_: Union[list, tuple] = ()) -> Union[list, tuple]:
    original_type = type(items)
    return original_type([item for item in items if item not in exclude_])


def get_installed_packages(version: str) -> list:
    cmd = "dpkg -l | grep php%s | sed 's/^ii\s*//' | sed 's/\s\{3,\}.*$//' | tr '\n' ' '"
    packages = run(cmd % version, capture_output=True)
    packages = packages.strip().split(' ')
    return list(filter(lambda package: bool(package), packages))


def get_os_release() -> dict:
    if hasattr(platform, 'freedesktop_os_release'):
        try:
            return platform.freedesktop_os_release()
        except OSError:
            pass

    path = get_os_release_path()

    if not path:
        return {}

    with open(path) as f:
        reader = csv.reader(f, delimiter="=")
        return {key: value for key, value in reader}


def get_os_release_path() -> Optional[str]:
    root = os.path.abspath(os.sep)
    path = os.path.join(root, 'etc', 'os-release')
    if os.path.exists(path):
        return path

    path = os.path.join(root, 'usr', 'lib', 'os-release')
    if os.path.exists(path):
        return path

    return None


def install_php(version: str, env: str, add: Union[list, tuple], remove: Union[list, tuple]) -> int:
    global php_extensions, php_versions

    if version not in php_versions['install']:
        print('Invalid php version')
        return FAILURE

    if env not in php_extensions:
        print('Environment not supported')
        return FAILURE

    # combine the packages to be installed
    extensions = ['bcmath', 'cli', 'common', 'curl', 'mbstring', 'mysql', 'opcache', 'pgsql',
                  'readline', 'sqlite3', 'xml', 'zip', *php_extensions[env], *add]

    if to_tuple_version(version) < (8, 0):
        extensions.append('json')

    # filter out any extensions we don't want
    extensions = exclude(unique(extensions), remove)

    # build the extension strings and add them to the packages list
    packages = [f"php{version}", *list(map(lambda ext: f"php{version}-{ext}", extensions))]

    print("")
    print("Packages to be installed:")
    print(*packages, sep='\n')

    print("")
    if confirm('Proceed?'):
        if not php_sources_are_installed():
            install_php_sources()

        run("sudo apt update")
        run("sudo apt install -y", *packages)
    else:
        print("Exiting...")

    print("")
    return SUCCESS


def install_php_sources() -> None:
    if os_id() in ['debian', 'raspbian']:
        packages = ['apt-transport-https', 'ca-certificates', 'software-properties-common', 'lsb-release', 'gnupg2']
        run('sudo apt install -y', *packages)
        run('sudo wget -O /etc/apt/trusted.gpg.d/php.gpg https://packages.sury.org/php/apt.gpg')
        source = 'deb https://packages.sury.org/php/ $(lsb_release -sc) main'
        source_file_path = '/etc/apt/sources.list.d/sury-php.list'
        run(f'echo "{source}" | sudo tee "{source_file_path}"')
    elif os_id() == 'ubuntu':
        packages = ['software-properties-common', 'lsb-release']
        run('sudo apt install -y', *packages)
        run('sudo add-apt-repository ppa:ondrej/php -y')
    else:
        raise Exception('Unsupported os')


def os_id() -> str:
    """
    Get the operating system's identifier. If not a freedesktop
    system, this will just return the type of system.
    """
    system_type = os_type()

    if system_type in ['linux', 'freebsd']:
        return release_info('ID')

    return system_type


def os_id_like() -> tuple:
    """
    The operating systems that the the local operating system is based on. If
    not a freedesktop system, this will just return the type of system.
    """
    system_type = os_type()

    if system_type in ['linux', 'freebsd']:
        id_like = release_info('ID_LIKE')

        if not id_like:
            id_ = release_info('ID')
            return (id_,) if id_ else ()

        return tuple(id_like.split(' '))

    return system_type,


def os_type() -> str:
    """Get the type of operating system"""
    if sys.platform in ['win32', 'win64', 'cygwin']:
        return 'windows'

    system_type = platform.system().lower()

    if system_type == 'darwin':
        return 'mac'

    return system_type


def parse_script_args():
    global php_extensions

    parser = argparse.ArgumentParser(description='Install/Uninstall php')

    parser.add_argument('version', type=str, action='store',
                        help='the version to install')
    parser.add_argument('-u', '--uninstall', action='store_true', default=False,
                        help='uninstall the php version instead of install')
    parser.add_argument('-e', '--env', type=str, action='store', choices=php_extensions.keys(),
                        default='desktop', help="the type of environment you're installing php on")
    parser.add_argument('-a', '--add', type=str, action='extend', nargs="+", default=[],
                        help='additional extensions you want to install')
    parser.add_argument('-r', '--remove', type=str, action='extend', nargs="+", default=[],
                        help='extensions you want to exclude')

    return parser.parse_args()


def php_sources_are_installed() -> bool:
    """Check see if the php apt repository is installed"""
    cmd = "find /etc/apt/ -name *.list | xargs cat | grep ^[[:space:]]*deb | grep '%s' | grep 'php'"
    if os_id() in ['debian', 'raspbian']:
        if os.path.exists('/etc/apt/sources.list.d/sury-php.list'):
            return True
        proc = run(cmd % 'sury', check=False, supress_output=True)
        return proc.returncode == 0
    elif os_id() == 'ubuntu':
        if os.path.exists(f"/etc/apt/sources.list.d/ondrej-ubuntu-php-{release_info('VERSION_CODENAME')}.list"):
            return True
        proc = run(cmd % 'ondrej', check=False, supress_output=True)
        return proc.returncode == 0
    else:
        return False


def release_info(key: Optional[str] = None) -> Union[dict, str]:
    """Get a value form the /etc/os-release file"""
    global __os_release_data

    if not __os_release_data:
        __os_release_data = get_os_release()

    if key:
        return __os_release_data.get(key, '')

    return __os_release_data


def run(cmd: str, *args, **kwargs):
    """Run a shell command with or without sudo privileges"""
    cmd_arguments = [cmd, *args]
    supress_output = kwargs.get('supress_output', False)
    capture_output = False if supress_output else kwargs.get('capture_output', False)
    stdout = subprocess.DEVNULL if supress_output else None

    if kwargs.get('root', False):
        cmd_arguments.insert(0, 'sudo')

    process = subprocess.run(
        ' '.join(cmd_arguments),
        check=kwargs.get('check', True),
        shell=True,
        executable=os.environ['SHELL'],
        stdout=stdout,
        capture_output=capture_output,
        env=kwargs.get('env', None)
    )

    if capture_output:
        output = process.stderr if process.returncode > 0 else process.stdout
        return output.decode(sys.getdefaultencoding())

    return process


def to_tuple_version(version: str) -> tuple:
    version_parts = version.split('.')
    return tuple(map(lambda part: int(part), version_parts))


def uninstall_php(version: str) -> int:
    global php_versions

    if version not in php_versions['uninstall']:
        print("Invalid php version")
        return FAILURE

    packages = get_installed_packages(version)

    if len(packages) == 0:
        print("")
        print(f"No packages found for php{version}")
        print("")
        return SUCCESS

    print("")
    print('Packages to be uninstalled:')
    print(*packages, sep='\n')

    print("")
    if confirm('Proceed?'):
        run("sudo apt purge -y", *packages)
        run("sudo apt-get --purge autoremove -y")
    else:
        print("Exiting...")

    print("")
    return SUCCESS


def unique(items: Union[list, tuple]) -> Union[list, tuple]:
    original_type = type(items)
    return original_type(OrderedDict.fromkeys(items))


if __name__ == '__main__':
    if sys.version_info < (3, 8):
        print('python 3.8 and above is required')
        sys.exit(FAILURE)

    if os_id() not in ['debian', 'raspbian', 'ubuntu']:
        print('your os is not supported')
        sys.exit(FAILURE)

    script_args = parse_script_args()

    if script_args.uninstall:
        exit_status = uninstall_php(
            script_args.version
        )
    else:
        exit_status = install_php(
            script_args.version,
            script_args.env,
            tuple(script_args.add),
            tuple(script_args.remove)
        )

    sys.exit(exit_status)
