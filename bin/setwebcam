#!/usr/bin/env bash

# fail fast
set -Eeuo pipefail
# show the list of devices if there is an error
trap error_cleanup ERR

# Functions
error_cleanup() {
    trap - ERR
    cmsg ""
    cmsg -c "Here's the list of available devices:"
    v4l2-ctl --list-devices
}

is_int() {
    case "${1}" in
        ''|*[!0-9]*) return 1 ;;
        *) return 0;;
    esac
}

usage() {
    echo "usage: $(basename "${0}") [-h] [-l] {device_id}"
    echo ""
    echo "Adjusts the settings for your logitech webcam"
    echo ""
    echo "arguments:"
    echo "  device_id       The the numeric id of the webcam"
    echo ""
    echo "options:"
    echo "  -h              Displays this help message"
    echo "  -l              List all webcam devices"
}

case "$(uname -s)" in
    Linux*)  MACHINE="linux";;
    *)       MACHINE="UNKNOWN";;
esac

if [ "$MACHINE" != "linux" ]; then
    echo "Unsupported operating system [${UNAME}]."
    echo "Currently this script only supports Linux distributions." 1>&2
    exit 1
fi

# Script options
while getopts ":hl" o; do
    case "${o}" in
        h)
            usage
            exit 0
            ;;
        l)
            echo ""
            v4l2-ctl --list-devices
            exit 0
            ;;
        \?)
            echo "Invalid option '-${OPTARG}'";
            usage
            exit 1
            ;;
    esac
done
shift $((OPTIND-1))

# Default device number
device="${1:-0}"
if ! is_int "${device}"; then
    cmsg -r "Invalid device id" 1>&2
    exit 1
fi

cmsg -c "Setting webcam settings for device: /dev/video${device}"
#-----------------------------------------------------------------------------------------------------------------------

# settings
v4l2-ctl -d "${device}" --set-ctrl brightness=135
v4l2-ctl -d "${device}" --set-ctrl contrast=128
v4l2-ctl -d "${device}" --set-ctrl saturation=128
v4l2-ctl -d "${device}" --set-ctrl white_balance_temperature_auto=1
#v4l2-ctl -d "${device}" --set-ctrl white_balance_temperature=3800
v4l2-ctl -d "${device}" --set-ctrl gain=0
v4l2-ctl -d "${device}" --set-ctrl power_line_frequency=1
v4l2-ctl -d "${device}" --set-ctrl sharpness=128
v4l2-ctl -d "${device}" --set-ctrl backlight_compensation=0
v4l2-ctl -d "${device}" --set-ctrl exposure_auto=3
#v4l2-ctl -d "${device}" --set-ctrl exposure_absolute=250
v4l2-ctl -d "${device}" --set-ctrl exposure_auto_priority=0

# focus controls
#v4l2-ctl -d "${device}" --set-ctrl focus_auto=1
#v4l2-ctl -d "${device}" --set-ctrl pan_absolute=10000
#v4l2-ctl -d "${device}" --set-ctrl tilt_absolute=10000
#v4l2-ctl -d "${device}" --set-ctrl focus_absolute=20

# zoom?
#v4l2-ctl -d "${device}" --set-ctrl zoom_absolute=175

#-----------------------------------------------------------------------------------------------------------------------
cmsg -c "Done!"
